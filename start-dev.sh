#!/bin/bash

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¸¡æ–¹ã‚’ä¸¦è¡Œã—ã¦èµ·å‹•ã—ã¾ã™

echo "é™°é™½äº”è¡ŒAIã‚±ã‚¢ã‚³ãƒ³ãƒ‘ãƒ‹ã‚ªãƒ³ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•"
echo "--------------------------------------"

# ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
if [ ! -f .env ]; then
  echo "âš ï¸ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚.env.exampleã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚"
  exit 1
fi

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
echo "ðŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
if [ ! -d "backend/node_modules" ]; then
  echo "ðŸ”„ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."
  cd backend && npm install
  cd ..
fi

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
if [ ! -d "frontend/node_modules" ]; then
  echo "ðŸ”„ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."
  cd frontend && npm install
  cd ..
fi

# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
echo "ðŸš€ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™..."
echo "ðŸ“ ãƒ­ã‚°ã¯å„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«å‡ºåŠ›ã•ã‚Œã¾ã™"
echo ""
echo "ðŸ”— ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: http://localhost:3000"
echo "ðŸ”— ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ API: http://localhost:5000/api/v1"
echo ""
echo "â±ï¸ ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã«ã¯æ•°ç§’ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™"
echo "ðŸ“‹ çµ‚äº†ã™ã‚‹ã«ã¯ Ctrl+C ã‚’æŠ¼ã—ã¦ãã ã•ã„"
echo "--------------------------------------"

# ãƒ‡ãƒãƒƒã‚°ç”¨ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
echo "ðŸ” ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã„ã¾ã™..."
export NODE_OPTIONS="--trace-warnings --trace-uncaught"
export DEBUG="*"
export LOG_LEVEL="debug"
export SKIP_DB_ERRORS="true"

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆæœŸåŒ–
BACKEND_LOG_FILE="./backend/logs/debug-server.log"
mkdir -p ./backend/logs
echo "ðŸŒŸ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ãƒ­ã‚° - $(date)" > $BACKEND_LOG_FILE

# ä¸¡æ–¹ã®ã‚µãƒ¼ãƒãƒ¼ã‚’ä¸¦è¡Œã—ã¦èµ·å‹•
echo "ðŸ” ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ä¸¦è¡Œã—ã¦èµ·å‹•ã—ã¦ã„ã¾ã™..."
echo "ðŸ“ è©³ç´°ãªãƒ­ã‚°ã¯ $BACKEND_LOG_FILE ã«è¨˜éŒ²ã•ã‚Œã¾ã™"

# concurrentlyãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
if ! command -v npx &> /dev/null || ! npx concurrently --version &> /dev/null; then
  echo "ðŸ“¦ concurrentlyã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."
  npm install -g concurrently
fi

# ä¸¡æ–¹ã®ã‚µãƒ¼ãƒãƒ¼ã‚’ä¸¦è¡Œã—ã¦èµ·å‹•
npx concurrently \
  "cd backend && NODE_ENV=development PORT=5001 npm run dev 2>&1 | tee -a $BACKEND_LOG_FILE" \
  "cd frontend && npm start"