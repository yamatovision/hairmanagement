# データフロー改善実装計画

## 概要

パトロールマネジメントアプリケーションのデータフローとデータモデルの分析に基づき、特に四柱推命（サジュ）情報と運勢生成、AI対話システムの連携を改善する計画を提案します。段階的な実装計画に従って進めます。

## フェーズ1: データモデル標準化（2日）

### 1.1 User.sajuProfile 構造の統一と標準化

**目標**: elementalTypeとsajuProfileの重複を解消し、一貫した構造に統一する

**実装計画**:
1. User.modelの修正
   - elementalTypeをsajuProfileに統合
   - 十神情報と地支十神情報の表現を標準化（Mapをより厳格なオブジェクト構造に）
   - sajuProfileの各フィールドに適切なバリデーションを追加

2. 既存データの変換スクリプト
   - 現在のelementalTypeデータをsajuProfileに移行するスクリプト作成
   - データの整合性を確保するための検証ステップ

### 1.2 Fortune モデルの再構築

**目標**: より完全な四柱推命情報を含み、DailyCalendarInfoとの連携を強化する

**実装計画**:
1. Fortune.modelの拡張
   - dailyCalendarInfoIdフィールドの追加
   - sajuDataフィールドの導入（日主、日の五行、十神関係、地支十神関係など）
   - aiGeneratedAdvice構造の標準化

2. 関連リポジトリの更新
   - MongoFortuneRepositoryの更新
   - DailyCalendarInfoとの関連クエリの追加

### 1.3 DailyCalendarInfo モデルの最適化

**目標**: 日次の暦情報を効率的に保存・活用できる構造に

**実装計画**:
1. DailyCalendarInfo.modelの最適化
   - 五行情報の明示的な追加
   - 干支情報の完全化
   - インデックス最適化

## フェーズ2: データフロー強化（3日）

### 2.1 DailyCalendarInfo 生成自動化

**目標**: 日次の干支情報を自動的に計算・保存する機構を確立

**実装計画**:
1. DailyCalendarInfoService実装
   - 日付から暦情報を計算するロジック
   - 自動生成バッチジョブ設計

2. 運勢生成との連携強化
   - DailyFortuneServiceからDailyCalendarInfoを活用

### 2.2 運勢計算フローの改善

**目標**: 完全な四柱推命情報を活用した運勢計算

**実装計画**:
1. DailyFortuneServiceの改良
   - サジュプロファイルからの情報抽出ロジック改善
   - 地支十神情報の活用ロジック追加

2. 運勢計算アルゴリズムの強化
   - より詳細な四柱情報に基づく計算
   - AIアドバイス生成ロジックの一貫性確保

### 2.3 SystemMessageBuilder強化

**目標**: AIに完全な四柱推命情報を伝達

**実装計画**:
1. SystemMessageBuilderServiceの改良
   - 地支十神情報の完全な伝達
   - コンテキスト情報の拡充

## フェーズ3: システム統合（2日）

### 3.1 会話システムの統一

**目標**: direct-chat.tsとconversation.controller.tsの統合

**実装計画**:
1. 統合アプローチの決定
   - direct-chatをベースに機能を統合
   - conversation.controllerのサポート機能を統合

2. ルート構成の整理
   - /api/v1/direct-conversationsに集約
   - 既存ルートのリダイレクト設定

### 3.2 データアクセス層の標準化

**目標**: 一貫したデータアクセスパターンの確立

**実装計画**:
1. リポジトリインターフェースの標準化
   - IRepository基底インターフェースの改良
   - 特化したリポジトリの再設計

2. モンゴDBアクセス最適化
   - クエリの標準化
   - 共通パターンの抽出

## フェーズ4: テストと検証（2日）

### 4.1 ユニットテスト拡充

**目標**: 各コンポーネントの機能を検証

**実装計画**:
1. モデルとサービスのテスト
   - 標準化されたモデルのテスト
   - 改良されたサービスロジックのテスト

### 4.2 エンドツーエンドテスト

**目標**: データフロー全体を検証

**実装計画**:
1. 統合テストシナリオ作成
   - ユーザー登録から運勢計算、AI対話までの一連フロー
   - エッジケースの検証

### 4.3 パフォーマンス検証

**目標**: 改善の効果を数値化

**実装計画**:
1. ベンチマーク設定
   - API応答時間測定
   - リソース使用量監視

2. 最適化調整
   - ボトルネック特定と改善
   - キャッシュ戦略検討

## 実装スケジュール

1. フェーズ1 - データモデル標準化: 2日間
2. フェーズ2 - データフロー強化: 3日間
3. フェーズ3 - システム統合: 2日間
4. フェーズ4 - テストと検証: 2日間

**総所要時間**: 9日間