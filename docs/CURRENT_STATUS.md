# 実装状況 (2025/04/04更新)

## 全体進捗
- 完成予定ファイル数: 68
- 作成済みファイル数: 54
- 進捗率: 79%
- 最終更新日: 2025/04/04

> **四柱推命パトロールマネジメントシステム進捗状況**: 既存の陰陽五行システムから韓国式四柱推命システムへの移行計画を推進中です。クリーンアーキテクチャ版（`/patrolmanagement-clean/`）を基盤とし、既存の四柱推命計算ロジック（`/backend/src/utils/saju/`）を移植する「ハイブリッドアプローチ」を採用。実装は**79%**の状態で、四柱推命エンジンの拡張（十二運星計算と蔵干抽出機能を追加）、ユーザープロフィール機能拡張、サブスクリプションシステムの実装に加え、チームメンバー相性機能と会話サービスの実装を完了しました。管理者ダッシュボードの全機能（チーム管理、メンバー管理、チーム目標設定、サブスクリプション管理、チーム分析）も実装完了しました。四柱推命に基づくチームメンバー間の相性計算（五行相性、陰陽バランス、十神関係の分析）とチーム全体の五行バランス分析機能を実装し、チーム構成の最適化提案が可能になりました。また、AIモデル選択機能（Haiku/Sonnet）を統合したAI対話システムを実装し、四柱推命の知識に基づくパーソナライズされたアドバイス提供が可能になりました。デイリーフォーチュンとチームメンバー相性に特化した対話機能により、ユーザーは運勢や対人関係について深い洞察を得られます。

参考ファイル:
- backend/src/utils/saju/refactored/UNIFIED_ALGORITHM_DOCUMENT.md 
- backend/src/utils/saju/refactored/SajuEngine.ts
- backend/src/utils/saju/refactored/DateTimeProcessor.ts
- backend/src/domain/user/value-objects/saju-profile.ts
- backend/src/application/services/birth-location.service.ts
- backend/src/domain/entities/Subscription.ts
- backend/src/application/services/subscription.service.ts
- backend/src/application/services/ai-model-selector.service.ts
- backend/src/domain/entities/Team.ts
- backend/src/application/services/team-compatibility.service.ts
- backend/src/domain/entities/Conversation.ts
- backend/src/application/services/conversation.service.ts
- backend/src/infrastructure/external/ClaudeAIService.ts
- backend/src/interfaces/http/controllers/conversation.controller.ts
- frontend/src/components/profile/ProfileForm.tsx
- frontend/src/components/dashboard/SubscriptionManagement.tsx
- docs/requirements.md（絶対にこれは読むこと）
- packages/saju-engine/

## ページ構成
- **/profile**: 四柱推命の基本情報・五行属性・プロフィール設定
- **/fortune**: デイリーフォーチュンと運勢アドバイス
- **/dashboard**: 管理者専用画面（チーム管理・サブスクリプション管理）
- **/team**: チームメンバー一覧と相性情報

## 新規プロジェクト構造

### プロジェクト基盤
- [x] プロジェクト構造分析 (100%)
- [x] 実装アプローチ決定 (100%)
- [x] 詳細実装計画策定 (100%)
- [x] モノレポ設定調整 (100%)

### 四柱推命エンジン
- [x] saju-engineパッケージ作成 (100%)
- [x] 既存計算ロジックの移植 (100%)
- [x] 四柱推命ドメインモデル設計 (100%)
- [x] リポジトリインターフェース定義 (100%)
- [x] 四柱推命サービス実装 (100%)
- [x] 十二運星（十二長生）計算実装 (100%)
- [x] 蔵干（地蔵干）抽出実装 (100%)
- [x] 十二運星マッピング精度向上 (100%)

### プロフィール機能拡張
- [x] ユーザープロフィールに四柱推命情報フィールド追加 (100%)
- [x] 出生地情報の追加と処理 (100%)
- [x] プロフィール表示UI更新 (100%)
- [x] プロフィール編集機能拡張 (100%)
- [x] UI検証とフィードバック収集 (100%)

### サブスクリプションシステム
- [x] サブスクリプションドメインモデル設計 (100%)
- [x] サブスクリプションリポジトリ実装 (100%)
- [x] サブスクリプションサービス実装 (100%)
- [x] AIモデル切替機能実装 (100%)

### 管理者ダッシュボード
- [x] チーム管理機能 (100%)
- [x] メンバー管理機能 (100%)
- [x] チーム目標設定機能 (100%)
- [x] サブスクリプション管理機能 (100%)
- [x] チーム分析機能 (100%)

### デイリーフォーチュン機能
- [x] デイリーフォーチュンドメインサービス実装 (100%)
- [x] 基本運勢表示機能 (100%)
- [x] チーム目標連携機能 (100%)
- [x] 運勢履歴表示機能 (100%)
- [x] フロントエンドAPI統合 (100%)

### チームメンバー機能
- [x] メンバー一覧表示 (100%) 
- [x] メンバー間相性計算サービス実装 (100%)
- [x] 相性情報表示 (100%)

### AI会話サービス
- [x] AI運勢生成サービス実装 (100%)
- [x] AI対話機能実装 (100%)
- [x] コンテキスト管理 (100%)

### 統合とテスト
- [ ] E2Eテスト実装 (0%)
- [ ] パフォーマンス最適化 (0%)
- [ ] デプロイパイプライン設定 (0%)

## 詳細実装計画 (修正版: 2025/04/01)

### Phase 1: 四柱推命エンジンの構築と統合 (日程: 2025/04/02-04/04)
- `@repo/saju-engine` パッケージの作成
- 四柱推命計算ロジックの移植
- ドメインモデルとリポジトリインターフェースの設計
- サービス層の実装

### Phase 2: プロフィール機能拡張 (日程: 2025/04/05-04/07)
- ユーザープロフィールに四柱推命情報フィールドの追加
- 出生地情報の追加と地理的データ処理
- プロフィール表示UIの更新（五行属性、陰陽表示）
- プロフィール編集機能の拡張
- UI検証とユーザーフィードバックの収集

### Phase 3: サブスクリプションシステムの実装 (日程: 2025/04/08-04/10)
- サブスクリプションドメインモデルの設計
- リポジトリとサービスの実装
- AIモデル切替ロジックの実装

### Phase 4: チームメンバー相性機能と会話サービスの実装 (日程: 2025/04/04-04/07) - 完了
- チームエンティティとリポジトリの実装
- メンバー間相性計算サービスの実装
- チーム五行バランス分析機能の実装
- AI対話機能の実装
- 会話履歴の管理と検索機能の実装

### Phase 5: 管理者ダッシュボード実装 (日程: 2025/04/08-04/10) - 完了
- チーム管理機能の実装
- メンバー管理機能の実装
- チーム目標設定機能
- サブスクリプション管理機能のUI改善
- チーム五行分析UI実装

### Phase 6: デイリーフォーチュン機能 (日程: 2025/04/11-04/13)
- デイリーフォーチュンドメインサービスの実装
- 基本的な運勢計算と表示機能
- チーム目標と役割に基づく運勢アドバイス生成
- 運勢履歴表示機能
- フロントエンドAPI統合

### Phase 7: 統合とテスト (日程: 2025/04/20-04/22)
- E2Eテストの実装
- パフォーマンス最適化
- デプロイパイプラインの設定
- 最終調整

## 主要コンポーネント詳細

### 四柱推命エンジン
- SajuCalculator: 基本四柱推命計算
- SajuProfile: ユーザーの四柱推命プロファイル
- DailyFortune: 日次運勢情報
- CompatibilityService: 相性計算サービス
- TwelveFortuneSpiritCalculator: 十二運星（十二長生）計算
- HiddenStemExtractor: 蔵干（地蔵干）抽出

### プロフィール機能
- UserSajuProfile: ユーザーの四柱推命プロフィール情報
- BirthLocationService: 出生地情報処理サービス
- ProfileUIComponents: 四柱推命情報表示コンポーネント
- ElementalVisualization: 五行バランス可視化コンポーネント
- ProfileEditForm: 拡張プロフィール編集フォーム

### サブスクリプションシステム
- Subscription: サブスクリプション情報
- Plan: プラン種別（スタンダード/プレミアム）
- AiModel: AIモデル種別（Haiku/Sonnet）
- AiModelSelectorService: 状況に応じたモデル選択
- SubscriptionController: サブスクリプション管理API

### 管理者ダッシュボード
- TeamManagementService: チーム管理サービス
- TeamGoalService: チーム目標管理サービス
- MemberManagementService: メンバー管理サービス
- SubscriptionManagementService: サブスクリプション管理
- TeamAnalyticsService: チーム分析サービス
- TeamElementalAnalysis: 五行分析結果

### デイリーフォーチュン
- FortuneGenerationService: 運勢生成基盤サービス
- TeamGoalIntegrationService: チーム目標連携サービス
- FortuneHistoryComponent: 運勢履歴表示
- FortuneDetailView: 詳細運勢表示
- FortuneController: 運勢情報API

### チームメンバー機能
- TeamMemberListComponent: メンバー一覧表示
- TeamCompatibilityService: メンバー間相性計算
- CompatibilityVisualization: 相性可視化コンポーネント
- MemberRoleService: メンバー役割管理

### AI会話サービス
- AiFortuneGenerationService: AI運勢アドバイス生成
- AiChatService: AIチャットサービス
- ConversationController: 会話管理API
- ConversationContextManager: 会話コンテキスト管理

## リスクと対策

1. **四柱推命計算の移植リスク**
   - リスク: 複雑な計算ロジックの移植ミス
   - 対策: 詳細な単体テストの実装と結果検証

2. **AI統合リスク**
   - リスク: Claude APIの接続問題やモデル切替失敗
   - 対策: フォールバックメカニズムとエラーハンドリング強化

3. **パフォーマンスリスク**
   - リスク: 運勢計算やAI生成のレスポンス遅延
   - 対策: キャッシュ戦略とバックグラウンド処理の導入

4. **UX整合性リスク**
   - リスク: 異なるページ間での情報の一貫性の欠如
   - 対策: 共通コンポーネントの利用とUXレビュー

## 次のステップ

- ✓ ~~`@repo/saju-engine` パッケージの初期設定~~
- ✓ ~~ドメインモデルとリポジトリインターフェースの設計~~
- ✓ ~~四柱推命計算ロジックの移植完了~~
- ✓ ~~四柱推命計算サービス（SajuEngine）の実装~~
- ✓ ~~四柱推命エンジンの拡張機能実装~~
  - ✓ ~~十二運星（十二長生）計算の実装~~
  - ✓ ~~十二神殺計算の実装~~
  - ✓ ~~蔵干（地蔵干）抽出の実装~~
- ✓ ~~プロフィール機能拡張の設計と実装~~
  - ✓ ~~ユーザーモデルの拡張設計~~
  - ✓ ~~プロフィール表示UI設計~~
  - ✓ ~~出生地データ処理の実装~~
- ✓ ~~サブスクリプションシステムの設計と実装~~
  - ✓ ~~プラン種別とAIモデル連携の仕様策定~~
  - ✓ ~~サブスクリプションドメインモデルの実装~~
  - ✓ ~~サブスクリプション管理UI実装~~
- ✓ ~~チームメンバー相性機能と会話サービスの実装~~
  - ✓ ~~チームエンティティとリポジトリの設計と実装~~
  - ✓ ~~チーム相性計算サービスの実装~~
  - ✓ ~~会話サービスと履歴管理の実装~~
  - ✓ ~~AI対話機能の実装（Claude API統合）~~
  - ✓ ~~チームメンバー相性チャットとデイリーフォーチュンチャットの実装~~
- ✓ ~~管理者ダッシュボードの実装~~
  - ✓ ~~チーム管理機能の設計と実装~~
  - ✓ ~~メンバー管理機能の設計と実装~~
  - ✓ ~~チーム五行分析UIの設計と実装~~

## 実装状況詳細

第一〜第四フェーズの実装が完了しました。また、四柱推命エンジンの拡張（十二運星、十二神殺、蔵干計算）も実装しました。以下は実装したことの概要です：

### リファクタリング計画に基づく新実装

1. **DateTimeProcessor クラス**:
   - 生年月日と出生地から地方時調整を行う機能
   - 旧暦変換機能を一元管理
   - 節気情報の取得と処理
   - 日時データの前処理を担当

2. **SajuEngine クラス**:
   - 四柱推命計算のコアエンジン
   - 明確なデータフロー（入力→前処理→計算→出力）
   - 堅牢なエラー処理とフォールバックメカニズム
   - シンプルなAPI（`calculate`と`getCurrentSaju`）

3. **四柱計算プロセスの改善**:
   - 日時処理と四柱計算の明確な分離
   - 年柱→日柱→月柱→時柱の計算順序の適正化
   - 陰陽五行属性のプロファイル生成機能

4. **拡張計算モジュールの追加**:
   - **TwelveLifeCycleCalculator**: 十二運星（十二長生）計算
     - 日主の五行に基づく十二運星順序の決定
     - 12段階の生命周期（長生〜養）の計算
   - **TwelveGodKillCalculator**: 十二神殺計算
     - 年支と日支の組み合わせに基づく神殺特定
     - 運気への特殊な影響の計算
   - **HiddenStemExtractor**: 蔵干（地蔵干）抽出
     - 各地支に隠れた天干の抽出ロジック
     - 複数の蔵干を持つ地支の処理

5. **テスト環境の整備**:
   - `testSajuEngine.ts`によるテストケース
   - 実際の生年月日時データを使った検証
   - パフォーマンスと精度のテスト
   - 韓国式四柱推命サンプルとの照合

### 既存機能からの拡張

Sajuエンジンのリポジトリ層の実装も完了しました：

1. MongoDB用のベースリポジトリ：共通のCRUD操作を提供するBaseMongoRepositoryクラス
2. データベース接続管理：DatabaseConnectionクラスによるMongoDBへの接続管理
3. ドメインリポジトリの実装：
   - MongoSajuProfileRepository - 四柱推命プロファイルの永続化
   - MongoDailyFortuneRepository - デイリーフォーチュンの永続化
4. リポジトリファクトリー：依存性注入システムと連携してリポジトリを提供
5. モックリポジトリサポート：テストやモック環境用のインメモリリポジトリ

### 実装された計算フロー

新しいSajuEngineでは、以下のフローで四柱を計算します：

1. **入力処理**:
   - 生年月日、出生時間、性別、出生地の情報を受け取る

2. **時間調整**:
   - `DateTimeProcessor`が出生地の経度に基づき地方時調整を実施
   - 調整された日時データを生成

3. **旧暦変換**:
   - 調整された日時を旧暦に変換
   - 節気情報も同時に取得

4. **四柱計算**:
   - 年柱: 調整日時の年から計算
   - 日柱: 調整日時から60干支サイクルで計算
   - 月柱: 年干と節気情報から計算
   - 時柱: 日干と時間から計算

5. **五行プロファイル生成**:
   - 日主の五行（主要な五行）と陰陽の抽出
   - 月柱からの副次的五行の抽出
   - 五行プロファイルの構成

6. **十二運星（十二長生）計算**:
   - sample.mdとcalender.mdのデータ分析に基づくマッピング方式を採用
   - 干支60組合せに対する十二運星の直接マッピングテーブルを実装
   - 各柱（年、月、日、時）の地支に対応する十二運星を計算
   - 「長生、沐浴、冠帯、臨官、帝王、衰、病、死、墓、絶、胎、養」の12段階を正確に算出

7. **蔵干（地蔵干）抽出**:
   - 各柱の地支に隠れた天干（蔵干）を抽出
   - 地支と蔵干の関係に基づいた潜在的影響を分析

### テスト方法

`backend/src/utils/saju/refactored/testSajuEngine.ts`を使ってSajuEngineの精度とパフォーマンスをテストします。

### サブスクリプションシステムの実装

第三フェーズでは、サブスクリプションシステムを実装しました：

1. **サブスクリプションドメインモデル**:
   - `Plan` 列挙型：スタンダードとプレミアムプランの定義
   - `AiModel` 列挙型：HaikuとSonnetモデルの定義
   - `SubscriptionStatus` 列挙型：アクティブ、一時停止、キャンセルなどの状態
   - `ISubscription` インターフェース：サブスクリプションの基本プロパティとメソッド
   - `Subscription` エンティティ：サブスクリプションの永続化可能な表現

2. **サブスクリプションリポジトリ**:
   - `ISubscriptionRepository` インターフェース：標準的なCRUD操作と特殊なクエリ
   - `MongoSubscriptionRepository` クラス：MongoDBを使用した実装
   - `SubscriptionModel` スキーマ：データベースマッピング定義

3. **サブスクリプションサービス**:
   - `SubscriptionService` クラス：ビジネスロジックとリポジトリの仲介
   - 新規サブスクリプション作成、更新、ステータス変更機能
   - プラン変更と履歴管理機能

4. **AIモデル切替機能**:
   - `AiModelSelectorService` クラス：サブスクリプションプランに基づいたAIモデル選択
   - コンテキスト依存モデル選択：運勢生成用とAI対話用で異なる基準
   - フォールバックメカニズム：エラー時にデフォルトモデルを使用

5. **管理者ダッシュボード統合**:
   - サブスクリプション管理UI用の `SubscriptionManagement` コンポーネント
   - プラン変更、ステータス管理、履歴表示機能
   - 権限ベースのアクセス制御との統合

6. **フロントエンドAPI統合**:
   - REST APIとの通信を行う `subscription.service.ts`
   - 型安全なデータモデルの共有 (`models.ts`)
   - エラーハンドリングとローディング状態の管理

サブスクリプションシステムによって、標準プラン（運勢生成にSonnet、AI対話にHaiku）とプレミアムプラン（両方にSonnet）の切り替えが可能になり、AI対話の質とパフォーマンスをユーザーのニーズに合わせて最適化できるようになりました。

将来的な拡張として、ストライプ/ユニバペイとの決済連携、管理者によるユーザー直接追加機能の強化、およびAIコンテキストへのチーム目標情報の統合強化を予定しています。

### チームメンバー相性機能と会話サービスの実装

第四フェーズでは、チームメンバー相性機能と会話サービスを実装しました。また、管理者ダッシュボードのユーザー管理機能強化も実装しました：

1. **チーム関連のエンティティとリポジトリ**:
   - `Team` エンティティ：チーム情報とメンバー管理機能を実装
   - `ITeamRepository` インターフェース：チームの永続化と検索操作を定義
   - `MongoTeamRepository` クラス：MongoDBを使用した実装
   - チームメンバーの役割と状態の管理機能

2. **チーム相性計算サービス**:
   - `TeamCompatibilityService` クラス：メンバー間の相性計算を実装
   - 五行相性（相生・相剋関係）の分析
   - 陰陽バランスの評価
   - 十神関係に基づく役割相性の分析
   - チーム全体の五行バランス分析と最適化提案機能
   - 個人特性に基づく役割推奨機能
   - チーム目標を考慮したメンバー相性分析

3. **会話エンティティとリポジトリ**:
   - `Conversation` エンティティ：会話とメッセージの管理
   - `IConversationRepository` インターフェース：会話の永続化と検索操作
   - `MongoConversationRepository` クラス：MongoDB実装
   - 会話タイプ（一般、運勢、チームメンバー相性）の識別と特化処理
   - お気に入り機能とアーカイブ機能

4. **会話サービス**:
   - `ConversationService` クラス：会話の作成と管理を実装
   - 会話セッションの維持と履歴管理
   - コンテキスト維持のためのシステムメッセージ構築
   - 四柱推命情報やチーム情報を含むパーソナライズされたプロンプト生成
   - デイリーフォーチュンチャットとチームメンバー相性チャットの特殊化

5. **AI統合**:
   - `ClaudeAIService` クラス：Claude APIとの連携
   - サブスクリプションに基づくAIモデル（Haiku/Sonnet）の動的選択
   - フォールバックメカニズムとエラーハンドリング
   - メッセージフォーマットの変換とレスポンス処理
   - チーム目標情報を含むコンテキストウィンドウの構築

6. **会話コントローラーとルート**:
   - REST APIエンドポイントの実装
   - 認証とアクセス制御
   - 会話の作成、取得、アーカイブ、お気に入り機能
   - 会話履歴の最適化とページネーション
   - 呼び水質問生成機能
   
7. **管理者ダッシュボードの機能拡張**:
   - ユーザー追加機能（名前、パスワード、メールアドレス、サブスクプラン指定）
   - ユーザー管理テーブル/一覧表示
   - メンバー役割の自由入力形式での設定
   - チーム目標コンサルティング用対話ボタン

これにより、ユーザーは自分の四柱推命情報に基づいたパーソナライズされたAI対話を利用でき、デイリーフォーチュンの詳細を理解したり、チームメンバーとの相性について深い洞察を得たりできるようになりました。AIモデル選択機能との統合により、ユーザーのサブスクリプションに応じた適切なAIモデルが自動的に使用され、コストと品質のバランスが最適化されます。

さらに、管理者ダッシュボードの機能も拡張され、ユーザーの追加や管理がより効率的に行えるようになりました。チーム目標を自由に設定し、それに基づいたAI対話を通じてチーム運営の相談ができる機能も追加され、より実用的なマネジメント支援ツールとして進化しています。


