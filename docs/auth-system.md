# 認証システム ドキュメント

## 概要

このアプリケーションでは、JWT (JSON Web Token) ベースの認証システムを実装しています。ユーザーがログインすると、アクセストークンとリフレッシュトークンが発行され、これらのトークンを使用して保護されたリソースにアクセスできます。

## 認証フロー

1. **ログイン**
   - ユーザーが認証情報（メールアドレスとパスワード）を提供
   - バックエンドがユーザーを検証し、JWTアクセストークンとリフレッシュトークンを発行
   - トークンはHTTPOnlyクッキーとローカルストレージの両方に保存（クロスドメインアクセス対応）

2. **認証済みリクエスト**
   - クライアントはAuthorizationヘッダー（`Bearer {token}`形式）でトークンを送信
   - サーバーはトークンを検証し、有効な場合はリクエストを処理

3. **トークンリフレッシュ**
   - アクセストークンの有効期限が切れると、リフレッシュトークンを使用して新しいアクセストークンを取得
   - フロントエンドは50分ごとに自動的にトークンをリフレッシュ

4. **ログアウト**
   - クライアント側でトークンを削除
   - サーバー側でリフレッシュトークンを無効化

## セキュリティ対策

- パスワードはbcryptでハッシュ化して保存
- JWTトークンは適切な有効期限を設定（アクセストークン: 1時間、リフレッシュトークン: 7日間）
- HTTPOnlyクッキーを使用してCSRF攻撃を防止
- ロールベースのアクセス制御を実装

## 実装の詳細

### バックエンド

- **認証サービス**: `/backend/src/services/auth.service.ts`
  - ログイン、ログアウト、トークンリフレッシュなどの機能を提供

- **認証ミドルウェア**: `/backend/src/api/middlewares/auth.middleware.ts`
  - トークン検証と認可を処理

- **認証コントローラー**: `/backend/src/api/controllers/auth.controller.ts`
  - 認証関連のAPIエンドポイントを処理

- **トークンモデル**: `/backend/src/models/token.model.ts`
  - リフレッシュトークンを保存

### フロントエンド

- **認証コンテキスト**: `/frontend/src/contexts/AuthContext.tsx`
  - アプリケーション全体で認証状態を管理

- **認証サービス**: `/frontend/src/services/auth.service.ts`
  - バックエンドのAPI呼び出しを処理

- **保護されたルート**: `/frontend/src/components/common/ProtectedRoute.tsx`
  - 認証が必要なルートへのアクセスを制御

## 認証APIエンドポイント

| エンドポイント | メソッド | 説明 | 認証 |
|--------------|---------|------|------|
| `/api/v1/auth/login` | POST | ユーザーログイン | No |
| `/api/v1/auth/refresh-token` | POST | トークンリフレッシュ | No |
| `/api/v1/auth/logout` | POST | ログアウト | Yes |
| `/api/v1/auth/me` | GET | 現在のユーザー情報 | Yes |
| `/api/v1/auth/register` | POST | ユーザー登録 | Yes (Admin) |
| `/api/v1/auth/forgot-password` | POST | パスワードリセットメール送信 | No |
| `/api/v1/auth/reset-password` | POST | パスワードリセット | No |
| `/api/v1/auth/me/password` | PUT | パスワード変更 | Yes |

## テスト

認証システムをテストするには、以下のコマンドを実行します：

```bash
# MongoDB接続とログインフローのテスト
node test-login.js

# フロントエンドとバックエンドの開発サーバーを起動
chmod +x start-dev.sh
./start-dev.sh
```

## ユーザーロール

システムには以下のユーザーロールがあります：

- **管理者 (admin)**: すべての機能にアクセス可能（ユーザー管理など）
- **マネージャー (manager)**: チーム管理機能にアクセス可能
- **従業員 (employee)**: 基本的な機能のみアクセス可能

## 注意事項

- 本番環境では、適切な環境変数設定（JWTシークレットなど）を行ってください
- セキュリティを確保するため、HTTPSの使用が推奨されます
- パスワードリセット機能は、実際のメール送信を実装する必要があります