# 韓国式四柱推命 - 時柱計算アルゴリズム

時柱（時間の干支）の計算アルゴリズムについての説明です。

## 時柱の概要

時柱は四柱推命において、誕生時間を表す柱です。伝統的な時間の区分である12の時辰（二十四時間を12等分）と、60干支のシステムによって計算されます。

## 基本原則

1. **時間と地支の対応**
   - 子の刻 (23:00-01:00) → 子（ねずみ）
   - 丑の刻 (01:00-03:00) → 丑（牛）
   - 寅の刻 (03:00-05:00) → 寅（虎）
   - 卯の刻 (05:00-07:00) → 卯（兎）
   - 辰の刻 (07:00-09:00) → 辰（龍）
   - 巳の刻 (09:00-11:00) → 巳（蛇）
   - 午の刻 (11:00-13:00) → 午（馬）
   - 未の刻 (13:00-15:00) → 未（羊）
   - 申の刻 (15:00-17:00) → 申（猿）
   - 酉の刻 (17:00-19:00) → 酉（鶏）
   - 戌の刻 (19:00-21:00) → 戌（犬）
   - 亥の刻 (21:00-23:00) → 亥（猪）

2. **時干（時間の天干）の決定**
   - 日干（日の天干）によって、時干のパターンが決まります
   - 各日干は、時間ごとに対応する天干を持ちます

## 時干決定の原則

1. **日干に基づく時干の基準**
   - 甲・己の日: 子の刻は「甲子」から始まる
   - 乙・庚の日: 子の刻は「丙子」から始まる
   - 丙・辛の日: 子の刻は「戊子」から始まる
   - 丁・壬の日: 子の刻は「庚子」から始まる
   - 戊・癸の日: 子の刻は「壬子」から始まる

2. **時干のサイクル**
   - 子の刻から始まり、1刻（2時間）ごとに天干が変わる
   - 例: 丙の日の場合、「戊子→己丑→庚寅→辛卯→...」というパターンで進む

## 時干算出アルゴリズム

1. **時刻から地支を決定**
   - 入力された時間をもとに、該当する地支（時辰）を特定
   - 例: 5時 → 寅の刻 → 寅

2. **日干から時干の基準インデックスを決定**
   - 日干に対応する基準インデックスを取得
   - 甲己日: 0（甲）、乙庚日: 2（丙）、丙辛日: 4（戊）、丁壬日: 6（庚）、戊癸日: 8（壬）

3. **時干を計算**
   - 子（0）から始まり、地支のインデックスに基準インデックスを加えて時干を算出
   - 時干インデックス = (日干の基準インデックス + 地支のインデックス) % 10
   - 例: 丙の日の寅の刻 → 基準インデックス4 + 地支インデックス2 = 6 → 6 % 10 = 6 → 庚

4. **蔵干（地支に内包される天干）を取得**
   - 時支（地支）に対応する蔵干をマッピングテーブルから取得

## 実装コード

```typescript
/**
 * 時辰（地支）のインデックスを取得
 * @param hour 時間（0-23）
 * @returns 地支のインデックス（0-11）
 */
export function getHourBranchIndex(hour: number): number {
  return Math.floor(hour / 2) % 12;
}

/**
 * 韓国式で時柱を計算
 * @param hour 時間（0-23）
 * @param dayStem 日干
 * @returns 時柱情報
 */
export function calculateKoreanHourPillar(hour: number, dayStem: string): Pillar {
  // 地支（支）の計算
  const branchIndex = getHourBranchIndex(hour);
  const branch = BRANCHES[branchIndex];
  
  // 日干から時干の基準インデックスを取得
  const DAY_STEM_TO_HOUR_STEM_BASE: Record<string, number> = {
    "甲": 0, "乙": 2, "丙": 4, "丁": 6, "戊": 8,
    "己": 0, "庚": 2, "辛": 4, "壬": 6, "癸": 8
  };
  const hourStemBase = DAY_STEM_TO_HOUR_STEM_BASE[dayStem];
  
  // 時干を計算
  // 子の刻から始まり、各時辰ごとに天干が1つずつ進む
  const stemIndex = (hourStemBase + branchIndex) % 10;
  const stem = STEMS[stemIndex];
  
  return {
    stem,
    branch,
    fullStemBranch: `${stem}${branch}`,
    hiddenStems: getHiddenStems(branch)
  };
}
```

## 検証例

### 事例1: 丙の日の各時刻
- 日干: 丙
- 基準: 子の刻は「戊子」から始まる

| 時間  | 時刻 | 地支 | 時干計算                       | 時柱    |
|-----|-----|-----|----------------------------|-------|
| 1時  | 子  | 子(0) | 4 + 0 = 4 % 10 = 4 → 戊   | 戊子    |
| 5時  | 寅  | 寅(2) | 4 + 2 = 6 % 10 = 6 → 庚   | 庚寅    |
| 9時  | 辰  | 辰(4) | 4 + 4 = 8 % 10 = 8 → 壬   | 壬辰    |
| 13時 | 午  | 午(6) | 4 + 6 = 10 % 10 = 0 → 甲  | 甲午    |
| 17時 | 申  | 申(8) | 4 + 8 = 12 % 10 = 2 → 丙  | 丙申    |
| 21時 | 戌  | 戌(10) | 4 + 10 = 14 % 10 = 4 → 戊 | 戊戌    |

### 事例2: 癸の日の各時刻
- 日干: 癸
- 基準: 子の刻は「壬子」から始まる

| 時間  | 時刻 | 地支 | 時干計算                      | 時柱   |
|-----|-----|-----|---------------------------|------|
| 0時  | 子  | 子(0) | 8 + 0 = 8 % 10 = 8 → 壬   | 壬子   |
| 4時  | 寅  | 寅(2) | 8 + 2 = 10 % 10 = 0 → 甲  | 甲寅   |
| 8時  | 辰  | 辰(4) | 8 + 4 = 12 % 10 = 2 → 丙  | 丙辰   |
| 12時 | 午  | 午(6) | 8 + 6 = 14 % 10 = 4 → 戊  | 戊午   |
| 16時 | 申  | 申(8) | 8 + 8 = 16 % 10 = 6 → 庚  | 庚申   |
| 20時 | 戌  | 戌(10) | 8 + 10 = 18 % 10 = 8 → 壬 | 壬戌   |

## 時柱の意味と解釈

- 時柱は、人の晩年や子孫、キャリアの後半、隠れた才能や人生の終盤を表すとされる
- 時干と日干の相互関係は、本人の自己認識や能力発揮に関わる
- 時支と日支の相互関係は、本人の活動や姿勢、環境適応に関わる

## 蔵干の意味

時支（地支）の中に隠れている天干（蔵干）も四柱推命の解釈において重要な役割を果たします。例えば：

- 子（ねずみ）: 癸水のみを蔵する
- 午（馬）: 丁火と己土を蔵する
- 卯（兎）: 乙木のみを蔵する

この蔵干の影響も運勢解釈では考慮されます。