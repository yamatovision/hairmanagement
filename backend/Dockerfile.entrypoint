FROM node:18-alpine

WORKDIR /app

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm init -y && npm install express cors mongoose jsonwebtoken

# ã‚·ãƒ³ãƒ—ãƒ«ãªã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ—ãƒªã‚’ä½œæˆ
COPY <<EOF /app/index.js
const express = require('express');
const cors = require('cors');
const app = express();
const port = process.env.PORT || 8080;
const apiPrefix = process.env.API_PREFIX || '/api';
const apiVersion = process.env.API_VERSION || 'v1';
const fullApiPrefix = \`\${apiPrefix}/\${apiVersion}\`;

// MongoDBæ¥ç¶šè¨­å®š
let mongoose;
let dbConnected = false;
const connectToDB = async () => {
  if (process.env.SKIP_DB === 'true') {
    console.log('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ï¼ˆSKIP_DB=trueï¼‰');
    return;
  }
  
  try {
    mongoose = require('mongoose');
    await mongoose.connect(process.env.DB_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    });
    console.log('ğŸ“Š MongoDBæ¥ç¶šæˆåŠŸ');
    dbConnected = true;
  } catch (error) {
    if (process.env.SKIP_DB_ERRORS === 'true') {
      console.log('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ï¼ˆSKIP_DB_ERRORS=trueï¼‰');
      console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
    } else {
      console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
      process.exit(1);
    }
  }
};

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
app.use(cors({ 
  origin: process.env.CORS_ORIGIN || '*',
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true // ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ä»˜ããƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯
}));
app.use(express.json());

// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚®ãƒ³ã‚°
if (process.env.ENABLE_REQUEST_LOGGING === 'true') {
  app.use((req, res, next) => {
    const start = Date.now();
    res.on('finish', () => {
      const duration = Date.now() - start;
      console.log(\`\${req.method} \${req.originalUrl} \${res.statusCode} \${duration}ms\`);
    });
    next();
  });
}

// ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆCloud Runç”¨ï¼‰
app.get('/healthz', (req, res) => {
  console.log('å¥åº·ãƒã‚§ãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡');
  res.status(200).send('OK');
});

// APIãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
app.get('/', (req, res) => {
  res.json({ 
    name: 'ãƒ‘ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ API',
    description: 'é™°é™½äº”è¡Œã®åŸç†ã«åŸºã¥ã„ãŸé‹å‹¢åˆ†æã¨çµ„ç¹”ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆAPI',
    status: 'ok',
    version: '1.0.0',
    apiPrefix: fullApiPrefix,
    environment: process.env.NODE_ENV,
    timestamp: new Date().toISOString(),
    dbConnected
  });
});

// èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
app.post(\`\${fullApiPrefix}/auth/login\`, (req, res) => {
  console.log('ãƒ­ã‚°ã‚¤ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:', req.body);
  // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
  res.json({
    success: true,
    message: 'ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ',
    data: {
      user: {
        id: 'user123',
        name: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
        email: req.body.email || 'test@example.com',
        role: 'user',
        element: {
          main: 'æœ¨',
          secondary: 'æ°´'
        },
        createdAt: new Date().toISOString()
      },
      token: 'mock-jwt-token-12345'
    }
  });
});

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.get(\`\${fullApiPrefix}/auth/me\`, (req, res) => {
  // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
  res.json({
    success: true,
    data: {
      id: 'user123',
      name: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
      email: 'test@example.com',
      role: 'user',
      element: {
        main: 'æœ¨',
        secondary: 'æ°´'
      },
      createdAt: new Date().toISOString()
    }
  });
});

// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post(\`\${fullApiPrefix}/auth/logout\`, (req, res) => {
  res.json({
    success: true,
    message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæˆåŠŸ'
  });
});

// é‹å‹¢ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.get(\`\${fullApiPrefix}/fortune/daily\`, (req, res) => {
  // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
  res.json({
    date: new Date().toISOString().split('T')[0],
    element: {
      day: "ç«",
      month: "æœ¨", 
      year: "æ°´"
    },
    fortune: {
      overall: 85,
      work: 80,
      relationship: 90,
      health: 85
    },
    advice: "ä»Šæ—¥ã¯ç©æ¥µçš„ãªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¹¸é‹ã‚’å‘¼ã³è¾¼ã¿ã¾ã™ã€‚æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å…±æœ‰ã—ã¾ã—ã‚‡ã†ã€‚",
    luckyColor: "èµ¤",
    luckyDirection: "å—",
    compatibleElement: "æœ¨"
  });
});

// ç¯„å›²é‹å‹¢ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.get(\`\${fullApiPrefix}/fortune/range\`, (req, res) => {
  const { startDate, endDate } = req.query;
  
  if (!startDate || !endDate) {
    return res.status(400).json({ error: "é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã¯å¿…é ˆã§ã™" });
  }
  
  // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
  const days = Math.ceil((new Date(endDate as string).getTime() - new Date(startDate as string).getTime()) / (1000 * 60 * 60 * 24)) + 1;
  const fortunes = [];
  
  for (let i = 0; i < days; i++) {
    const date = new Date(startDate as string);
    date.setDate(date.getDate() + i);
    
    fortunes.push({
      date: date.toISOString().split('T')[0],
      dailyElement: ["æœ¨", "ç«", "åœŸ", "é‡‘", "æ°´"][Math.floor(Math.random() * 5)],
      yinYang: Math.random() > 0.5 ? "é™°" : "é™½",
      overallLuck: 50 + Math.floor(Math.random() * 50),
      careerLuck: 50 + Math.floor(Math.random() * 50),
      relationshipLuck: 50 + Math.floor(Math.random() * 50),
      creativeEnergyLuck: 50 + Math.floor(Math.random() * 50),
      healthLuck: 50 + Math.floor(Math.random() * 50),
      wealthLuck: 50 + Math.floor(Math.random() * 50),
      description: "ã“ã®æ—¥ã¯èª¿å’Œã®ã¨ã‚ŒãŸä¸€æ—¥ã¨ãªã‚‹ã§ã—ã‚‡ã†ã€‚",
      advice: "ãƒãƒ©ãƒ³ã‚¹ã‚’æ„è­˜ã—ã¦è¡Œå‹•ã—ã¾ã—ã‚‡ã†ã€‚",
      luckyColors: ["é’", "ç·‘"],
      luckyDirections: ["æ±", "å—"],
      compatibleElements: ["æ°´", "æœ¨"],
      incompatibleElements: ["ç«", "é‡‘"]
    });
  }
  
  res.json(fortunes);
});

// é€±é–“é‹å‹¢ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.get(\`\${fullApiPrefix}/fortune/weekly\`, (req, res) => {
  const { startDate } = req.query;
  const start = startDate || new Date().toISOString().split('T')[0];
  
  // çµ‚äº†æ—¥ï¼ˆ7æ—¥å¾Œï¼‰
  const end = new Date(start as string);
  end.setDate(end.getDate() + 6);
  const endDate = end.toISOString().split('T')[0];
  
  // /fortune/range ã‚’å‘¼ã³å‡ºã™ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  req.query.endDate = endDate;
  const fortunes = [];
  
  for (let i = 0; i < 7; i++) {
    const date = new Date(start as string);
    date.setDate(date.getDate() + i);
    
    fortunes.push({
      date: date.toISOString().split('T')[0],
      dailyElement: ["æœ¨", "ç«", "åœŸ", "é‡‘", "æ°´"][Math.floor(Math.random() * 5)],
      yinYang: Math.random() > 0.5 ? "é™°" : "é™½",
      overallLuck: 50 + Math.floor(Math.random() * 50),
      careerLuck: 50 + Math.floor(Math.random() * 50),
      relationshipLuck: 50 + Math.floor(Math.random() * 50),
      creativeEnergyLuck: 50 + Math.floor(Math.random() * 50),
      healthLuck: 50 + Math.floor(Math.random() * 50),
      wealthLuck: 50 + Math.floor(Math.random() * 50),
      description: "ã“ã®æ—¥ã¯èª¿å’Œã®ã¨ã‚ŒãŸä¸€æ—¥ã¨ãªã‚‹ã§ã—ã‚‡ã†ã€‚",
      advice: "ãƒãƒ©ãƒ³ã‚¹ã‚’æ„è­˜ã—ã¦è¡Œå‹•ã—ã¾ã—ã‚‡ã†ã€‚",
      luckyColors: ["é’", "ç·‘"],
      luckyDirections: ["æ±", "å—"],
      compatibleElements: ["æ°´", "æœ¨"],
      incompatibleElements: ["ç«", "é‡‘"]
    });
  }
  
  res.json(fortunes);
});

// ä¼šè©±ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.post(\`\${fullApiPrefix}/conversation\`, (req, res) => {
  const { message } = req.body;
  
  if (!message) {
    return res.status(400).json({ error: "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" });
  }
  
  // ãƒ¢ãƒƒã‚¯å¿œç­”
  res.json({
    id: "conv_" + Date.now(),
    message: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãŠå½¹ã«ç«‹ã¦ã¦å¬‰ã—ã„ã§ã™ã€‚ä»–ã«ã”è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
    timestamp: new Date().toISOString()
  });
});

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
app.use((err, req, res, next) => {
  console.error('âŒ ã‚¨ãƒ©ãƒ¼:', err);
  res.status(500).json({ error: "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", details: err.message });
});

// 404ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
app.use((req, res) => {
  res.status(404).json({ error: "ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ" });
});

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã¨ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
const startServer = async () => {
  await connectToDB();
  
  app.listen(port, '0.0.0.0', () => {
    console.log(\`ğŸš€ ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸ: http://0.0.0.0:\${port}\`);
    console.log(\`ğŸ“š APIæ¥é ­è¾: \${fullApiPrefix}\`);
    console.log(\`ğŸŒ CORSè¨­å®š: \${process.env.CORS_ORIGIN || '*'}\`);
  });
};

startServer().catch(err => {
  console.error('âŒ ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚¨ãƒ©ãƒ¼:', err);
  process.exit(1);
});
EOF

# ç’°å¢ƒå¤‰æ•°
ENV NODE_ENV=production
ENV PORT=8080
ENV API_VERSION=v1
ENV API_PREFIX=/api
ENV SKIP_DB=false
ENV SKIP_DB_ERRORS=false

# ãƒãƒ¼ãƒˆã®å…¬é–‹
EXPOSE 8080

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
CMD ["node", "index.js"]