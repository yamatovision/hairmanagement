# ユーザーID不一致問題の解決レポート

## 問題の概要

`admin@example.com`としてログインすると、トークンに含まれるユーザーIDが`67e487dbc4a58a62d38ac6ac`になっていますが、このIDのユーザーはデータベースに存在せず、実際のユーザーのIDは`67e52f32fb1b7bc2b73744ce`です。この不一致により、四柱推命データが正しく取得できない問題が発生していました。

## 根本原因の調査

1. **認証プロセスの確認**:
   - `user-authentication.use-case.ts`でメールアドレスからユーザーを検索し、トークン生成時にそのIDを使用
   - トークン生成自体に問題はなく、データベース内の別のユーザーが関連している可能性

2. **データベース状態の確認**:
   - `check-user-id-mapping.js`を調査した結果、データベースには`admin@example.com`メールアドレスを持つユーザーが存在し、そのIDは`67e52f32fb1b7bc2b73744ce`
   - トークン内で使用されている`67e487dbc4a58a62d38ac6ac`のIDを持つユーザーはデータベースに存在しない

3. **直前のスクリプト調査**:
   - `fix-user-id-issue.js`, `create-login-user.js`など、この問題を対処するために作成された既存のスクリプトを確認
   - これらのスクリプトは新しいIDでユーザーを作成するアプローチをとっていたが、メールアドレスの一意性制約などで実装できていない可能性あり

## 解決策

以下2つの選択肢があります：

1. **データベース側でのアプローチ**:
   - トークンで使用されているIDを持つユーザーを作成するか、既存ユーザーのIDを変更する
   - この方法はデータ整合性に関するリスクがあり、同一メールアドレスの制約に違反する可能性あり

2. **コード側でのアプローチ** (実装済み):
   - `direct-chat.ts`でユーザーを検索する際、まずIDで検索し、失敗した場合はメールアドレスで再検索する機能を追加
   - これにより既存のトークンおよびデータ構造を変更せずに問題を解決

## 実装した解決策

`direct-chat.ts`を以下のように修正しました：

```typescript
// ユーザー情報の取得（IDで検索）
let user = await userRepository.findById(userId);

// ユーザーが見つからない場合、メールアドレスでの検索を試みる
if (!user && req.user?.email) {
  console.log(`ID ${userId} でユーザーが見つかりません。メールアドレス ${req.user.email} で検索を試みます...`);
  user = await userRepository.findByEmail(req.user.email);
  
  if (user) {
    console.log(`メールアドレス ${req.user.email} でユーザーが見つかりました。ID: ${user.id}`);
    console.log(`注意: トークン内のID ${userId} と実際のユーザーID ${user.id} が異なります`);
  }
}

if (!user) {
  console.log(`ユーザー情報が見つかりません: ID=${userId}, Email=${req.user?.email || '不明'}`);
  throw new Error('ユーザーが見つかりません');
}
```

## 長期的解決策

1. **認証ミドルウェアの改善**:
   - ユーザーID不一致の検出と対応をログイン時に行う仕組みを追加

2. **クリーンアップスクリプト**:
   - 不整合データの定期的な確認と修正を行うスクリプトの実装

3. **トークン再生成**:
   - 既存の古いトークンを無効化し、正しいIDのトークンを再生成するフローの実装

この修正により、既存システムへの影響を最小限に抑えながら問題を解決することができました。ログイン時にトークンに保存されるIDと実際のユーザーIDの不一致が残りますが、メールアドレスでの補助検索によって正しいユーザーデータにアクセスできるようになります。